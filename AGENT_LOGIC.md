# –ê–≥–µ–Ω—Ç–Ω–∞—è –ª–æ–≥–∏–∫–∞ –≤—Å–µ—Ö —Ä–µ–∂–∏–º–æ–≤ —Ä–∞–±–æ—Ç—ã

–≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç –æ–ø–∏—Å—ã–≤–∞–µ—Ç –¥–µ—Ç–∞–ª—å–Ω—É—é –ª–æ–≥–∏–∫—É —Ä–∞–±–æ—Ç—ã –∞–≥–µ–Ω—Ç–æ–≤ –≤–æ –≤—Å–µ—Ö —Ä–µ–∂–∏–º–∞—Ö —Å–∏—Å—Ç–µ–º—ã.

## –û–±–∑–æ—Ä —Ä–µ–∂–∏–º–æ–≤

–°–∏—Å—Ç–µ–º–∞ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç 4 –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ä–µ–∂–∏–º–∞ —Ä–∞–±–æ—Ç—ã:

1. **Chat** - –ø—Ä–æ—Å—Ç–æ–π –¥–∏–∞–ª–æ–≥ –±–µ–∑ –≤–µ–±-–ø–æ–∏—Å–∫–∞
2. **Web Search** (search) - –±—ã—Å—Ç—Ä—ã–π –≤–µ–±-–ø–æ–∏—Å–∫ —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ–º –∑–∞–ø—Ä–æ—Å–æ–≤
3. **Deep Search** (deep_search) - –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –≤–µ–±-–ø–æ–∏—Å–∫ —Å –≥–ª—É–±–æ–∫–∏–º–∏ –∏—Ç–µ—Ä–∞—Ü–∏—è–º–∏
4. **Deep Research** (deep_research) - –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–∞—è –º—É–ª—å—Ç–∏–∞–≥–µ–Ω—Ç–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è

---

## 1. Chat Mode (–ü—Ä–æ—Å—Ç–æ–π –¥–∏–∞–ª–æ–≥)

### –û–ø–∏—Å–∞–Ω–∏–µ
–†–µ–∂–∏–º –¥–ª—è –æ–±—ã—á–Ω–æ–≥–æ –¥–∏–∞–ª–æ–≥–∞ —Å LLM –±–µ–∑ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤–µ–±-–ø–æ–∏—Å–∫–∞ –∏ –≤–Ω–µ—à–Ω–∏—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤.

### –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã

**–í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:**
- –ó–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ N —Å–æ–æ–±—â–µ–Ω–∏–π, –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ `CHAT_HISTORY_LIMIT`)

**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞
2. –í—ã–∑–æ–≤ LLM —Å —Å–∏—Å—Ç–µ–º–Ω—ã–º –ø—Ä–æ–º–ø—Ç–æ–º
3. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ (`SynthesizedAnswer`)
4. –í–æ–∑–≤—Ä–∞—Ç –æ—Ç–≤–µ—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é

**–ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:**
- `ChatSearchService.answer_simple()`
- LLM: `chat_model` (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ `CHAT_MODEL`)
- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã: `chat_model_max_tokens` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 16384)

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –ù–µ—Ç –≤–µ–±-–ø–æ–∏—Å–∫–∞
- –ù–µ—Ç –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
- –ù–µ—Ç —Å–∫—Ä–∞–ø–∏–Ω–≥–∞
- –ü—Ä–æ—Å—Ç–æ–π LLM-–æ—Ç–≤–µ—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ –æ–±—É—á–µ–Ω–∏—è –º–æ–¥–µ–ª–∏
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ –¥–∏–∞–ª–æ–≥–∞ –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ N —Å–æ–æ–±—â–µ–Ω–∏–π, –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ `CHAT_HISTORY_LIMIT`)
- Structured output —Å retry –ª–æ–≥–∏–∫–æ–π –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏

**–ü—Ä–æ–º–ø—Ç:**
```
You are a helpful AI assistant. Provide clear, accurate, and helpful responses.
Return JSON with fields reasoning, answer, key_points.
Current date: {current_date}
```

**–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –≤—ã–≤–æ–¥:**
```python
class SynthesizedAnswer:
    reasoning: str  # –†–∞—Å—Å—É–∂–¥–µ–Ω–∏—è –º–æ–¥–µ–ª–∏
    answer: str     # –û—Å–Ω–æ–≤–Ω–æ–π –æ—Ç–≤–µ—Ç
    key_points: list[str]  # –ö–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã
```

---

## 2. Web Search Mode (–ë—ã—Å—Ç—Ä—ã–π –≤–µ–±-–ø–æ–∏—Å–∫)

### –û–ø–∏—Å–∞–Ω–∏–µ
–†–µ–∂–∏–º –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –≤–µ–±-–ø–æ–∏—Å–∫–∞ —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ–º –∑–∞–ø—Ä–æ—Å–æ–≤ –∏ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ –ø–æ–∏—Å–∫–æ–≤—ã–º–∏ –∑–∞–ø—Ä–æ—Å–∞–º–∏.

### –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã

**–í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:**
- –ó–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

**–ü—Ä–æ—Ü–µ—Å—Å:**

1. **–ü–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞** (`QueryRewrite`)
   - LLM –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å –¥–ª—è –ª—É—á—à–µ–≥–æ –ø–æ–∏—Å–∫–∞
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `search_summarization_model`

2. **–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ–∏—Å–∫–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤** (`SearchQueries`)
   - –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è 3 –ø–æ–∏—Å–∫–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–∞ (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ `deep_search_queries`)
   - –ö–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å - –≤–∞—Ä–∏–∞—Ü–∏—è –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞

3. **–ò—Ç–µ—Ä–∞—Ç–∏–≤–Ω—ã–π –ø–æ–∏—Å–∫** (2 –∏—Ç–µ—Ä–∞—Ü–∏–∏, –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ `speed_max_iterations`)
   - **–ò—Ç–µ—Ä–∞—Ü–∏—è 1:**
     - –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–π –ø–æ–∏—Å–∫ –ø–æ –≤—Å–µ–º —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –∑–∞–ø—Ä–æ—Å–∞–º
     - –ü–æ–ª—É—á–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (–º–∞–∫—Å–∏–º—É–º 8 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –Ω–∞ –∑–∞–ø—Ä–æ—Å, –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ `deep_search_max_results`)
     - –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ URL
     - –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–æ–º–µ–Ω–æ–≤/–∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤
     - –°–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ—Ä–∞–Ω–∂–∏–Ω–≥ (—Ç–æ–ø-6 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤, –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ `deep_search_rerank_top_k`)
     - –ì–µ–Ω–µ—Ä–∞—Ü–∏—è follow-up –∑–∞–ø—Ä–æ—Å–æ–≤ –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–π –∏—Ç–µ—Ä–∞—Ü–∏–∏
   
   - **–ò—Ç–µ—Ä–∞—Ü–∏—è 2:**
     - –ü–æ–∏—Å–∫ –ø–æ follow-up –∑–∞–ø—Ä–æ—Å–∞–º
     - –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Å –ø—Ä–µ–¥—ã–¥—É—â–µ–π –∏—Ç–µ—Ä–∞—Ü–∏–µ–π
     - –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è
     - –†–µ—Ä–∞–Ω–∂–∏–Ω–≥

4. **–°–∫—Ä–∞–ø–∏–Ω–≥ —Ç–æ–ø-URL** (4 URL, –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ `deep_search_scrape_top_n`)
   - –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–π —Å–∫—Ä–∞–ø–∏–Ω–≥ —Ç–æ–ø-—Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞

5. **–°–∏–Ω—Ç–µ–∑ –æ—Ç–≤–µ—Ç–∞** (`SynthesizedAnswer`)
   - LLM —Å–∏–Ω—Ç–µ–∑–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–∫—Ä–∞–ø–ª–µ–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
   - –î–ª–∏–Ω–∞ –æ—Ç–≤–µ—Ç–∞: 400-600 —Å–ª–æ–≤
   - –í–∫–ª—é—á–∞–µ—Ç —Ü–∏—Ç–∞—Ç—ã –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤

**–ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:**
- `ChatSearchService.answer_web()`
- `SearchTuning` —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏:
  - `mode="web"`
  - `max_results=8`
  - `queries=3`
  - `iterations=2`
  - `scrape_top_n=4`
  - `rerank_top_k=6`

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –ë—ã—Å—Ç—Ä—ã–π —Ä–µ–∂–∏–º (2 –∏—Ç–µ—Ä–∞—Ü–∏–∏)
- –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø–æ–∏—Å–∫–æ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã –¥–ª—è –ª—É—á—à–µ–≥–æ –ø–æ–∫—Ä—ã—Ç–∏—è
- –°–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ—Ä–∞–Ω–∂–∏–Ω–≥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (—Ç–æ–ª—å–∫–æ –¥–ª—è SearXNG, Tavily —É–∂–µ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω)
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏—è —Å–∫—Ä–∞–ø–ª–µ–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
- –¶–∏—Ç–∞—Ç—ã –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –≤ –æ—Ç–≤–µ—Ç–µ
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞ –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
- –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

**–ü–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö:**
```
User Query ‚Üí Query Rewrite ‚Üí Generate 3 Search Queries ‚Üí 
Iteration 1: Search ‚Üí Dedupe ‚Üí Filter ‚Üí Rerank ‚Üí Follow-up Queries ‚Üí
Iteration 2: Search ‚Üí Merge ‚Üí Dedupe ‚Üí Filter ‚Üí Rerank ‚Üí
Scrape Top 4 URLs ‚Üí Summarize ‚Üí Synthesize Answer ‚Üí Return
```

---

## 3. Deep Search Mode (–ö–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –≤–µ–±-–ø–æ–∏—Å–∫)

### –û–ø–∏—Å–∞–Ω–∏–µ
–†–µ–∂–∏–º –¥–ª—è –≥–ª—É–±–æ–∫–æ–≥–æ –≤–µ–±-–ø–æ–∏—Å–∫–∞ —Å –±–æ–ª—å—à–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –∏—Ç–µ—Ä–∞—Ü–∏–π –∏ –±–æ–ª–µ–µ —à–∏—Ä–æ–∫–∏–º –æ—Ö–≤–∞—Ç–æ–º –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤.

### –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã

**–í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:**
- –ó–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

**–ü—Ä–æ—Ü–µ—Å—Å:**

–ê–Ω–∞–ª–æ–≥–∏—á–µ–Ω Web Search Mode, –Ω–æ —Å —É–≤–µ–ª–∏—á–µ–Ω–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏:

1. **–ü–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞**
2. **–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ–∏—Å–∫–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤** (3 –∑–∞–ø—Ä–æ—Å–∞)
3. **–ò—Ç–µ—Ä–∞—Ç–∏–≤–Ω—ã–π –ø–æ–∏—Å–∫** (6 –∏—Ç–µ—Ä–∞—Ü–∏–π, –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ `balanced_max_iterations`)
   - –ö–∞–∂–¥–∞—è –∏—Ç–µ—Ä–∞—Ü–∏—è:
     - –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–π –ø–æ–∏—Å–∫
     - –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è
     - –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è
     - –†–µ—Ä–∞–Ω–∂–∏–Ω–≥
     - –ì–µ–Ω–µ—Ä–∞—Ü–∏—è follow-up –∑–∞–ø—Ä–æ—Å–æ–≤
4. **–°–∫—Ä–∞–ø–∏–Ω–≥ —Ç–æ–ø-URL** (4 URL)
5. **–°–∏–Ω—Ç–µ–∑ –æ—Ç–≤–µ—Ç–∞** (400-600 —Å–ª–æ–≤)

**–ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:**
- `ChatSearchService.answer_deep()`
- `SearchTuning` —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏:
  - `mode="deep"`
  - `max_results=8`
  - `queries=3`
  - `iterations=6`
  - `scrape_top_n=4`
  - `rerank_top_k=6`

**–û—Ç–ª–∏—á–∏—è –æ—Ç Web Search:**
- –ë–æ–ª—å—à–µ –∏—Ç–µ—Ä–∞—Ü–∏–π (6 –≤–º–µ—Å—Ç–æ 2, –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ `balanced_max_iterations`)
- –ë–æ–ª–µ–µ –≥–ª—É–±–æ–∫–æ–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ —Ç–µ–º—ã
- –ë–æ–ª—å—à–µ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ —Ä–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞–µ—Ç—Å—è
- –ë–æ–ª–µ–µ —Ç—â–∞—Ç–µ–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞ –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
- –£–ª—É—á—à–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ structured output

**–ü–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö:**
```
User Query ‚Üí Query Rewrite ‚Üí Generate 3 Search Queries ‚Üí 
Iteration 1-6: Search ‚Üí Dedupe ‚Üí Filter ‚Üí Rerank ‚Üí Follow-up Queries ‚Üí
Scrape Top 4 URLs ‚Üí Summarize ‚Üí Synthesize Answer ‚Üí Return
```

---

## 4. Deep Research Mode (–ú—É–ª—å—Ç–∏–∞–≥–µ–Ω—Ç–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞)

### –û–ø–∏—Å–∞–Ω–∏–µ
–ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω–∞—è –º—É–ª—å—Ç–∏–∞–≥–µ–Ω—Ç–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è —Å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏–µ–π —á–µ—Ä–µ–∑ —Å—É–ø–µ—Ä–≤–∞–π–∑–µ—Ä–∞ –∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç–æ–π –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –∞–≥–µ–Ω—Ç–æ–≤.

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:**
- **Supervisor Agent** - –≥–ª–∞–≤–Ω—ã–π –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä, –ø–ª–∞–Ω–∏—Ä—É–µ—Ç –∑–∞–¥–∞—á–∏ –∏ —É–ø—Ä–∞–≤–ª—è–µ—Ç –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—è–º–∏
- **Researcher Agents** (1-5 –∞–≥–µ–Ω—Ç–æ–≤) - –≤—ã–ø–æ–ª–Ω—è—é—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –∑–∞–¥–∞—á–∏
- **LangGraph Workflow** - –æ—Ä–∫–µ—Å—Ç—Ä–∏—Ä—É–µ—Ç –≤–µ—Å—å –ø—Ä–æ—Ü–µ—Å—Å

### –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã

#### –≠—Ç–∞–ø 1: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞

1. **Deep Search –≤ –Ω–∞—á–∞–ª–µ** (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ `deep_research_run_deep_search_first`)
   - –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –±—ã—Å—Ç—Ä—ã–π deep search –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–∞—á–∞–ª—å–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
   - –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ `deep_search_result`

2. **–£—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã** (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ `deep_research_enable_clarifying_questions`)
   - –ê–Ω–∞–ª–∏–∑ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å —É—Ç–æ—á–Ω–µ–Ω–∏–π
   - –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≤–æ–ø—Ä–æ—Å–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
   - –û–∂–∏–¥–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   - –û—Ç–≤–µ—Ç—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ `clarification_context`

3. **–ê–Ω–∞–ª–∏–∑ –∑–∞–ø—Ä–æ—Å–∞** (`analyze_query_node`)
   - –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–∞
   - –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
   - –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è

4. **–ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è** (`plan_research_enhanced_node`)
   - –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞–Ω–∞ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è
   - –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–ª—é—á–µ–≤—ã—Ö –∞—Å–ø–µ–∫—Ç–æ–≤ —Ç–µ–º—ã
   - –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–∞—á–∞–ª—å–Ω—ã—Ö –∑–∞–¥–∞—á

#### –≠—Ç–∞–ø 2: –°–æ–∑–¥–∞–Ω–∏–µ –∞–≥–µ–Ω—Ç–æ–≤

5. **–°–æ–∑–¥–∞–Ω–∏–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫ –∞–≥–µ–Ω—Ç–æ–≤** (`create_agent_characteristics_enhanced_node`)
   - –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∞–≥–µ–Ω—Ç–æ–≤ (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ `deep_research_num_agents`, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 4)
   - –°–æ–∑–¥–∞–Ω–∏–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∞–≥–µ–Ω—Ç–∞:
     - –°–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, "Technical Expert", "Historical Analyst")
     - –°—Ç–∏–ª—å —Ä–∞–±–æ—Ç—ã
     - –ü—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è –≤ –∏—Å—Ç–æ—á–Ω–∏–∫–∞—Ö

6. **–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞–≥–µ–Ω—Ç–Ω–æ–π –ø–∞–º—è—Ç–∏**
   - –°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Å—Å–∏–æ–Ω–Ω–æ–π –ø–∞–ø–∫–∏ –¥–ª—è –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è
   - –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–∞–ø–∫–∏:
     ```
     agent_sessions/{session_id}/
     ‚îú‚îÄ‚îÄ main.md              # –ì–ª–∞–≤–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è (–∫–ª—é—á–µ–≤—ã–µ –∏–Ω—Å–∞–π—Ç—ã)
     ‚îú‚îÄ‚îÄ draft_report.md      # –ß–µ—Ä–Ω–æ–≤–∏–∫ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞
     ‚îú‚îÄ‚îÄ supervisor.md        # –õ–∏—á–Ω—ã–µ –∑–∞–º–µ—Ç–∫–∏ —Å—É–ø–µ—Ä–≤–∞–π–∑–µ—Ä–∞
     ‚îú‚îÄ‚îÄ agents/
     ‚îÇ   ‚îú‚îÄ‚îÄ agent_1.md      # –§–∞–π–ª –∞–≥–µ–Ω—Ç–∞ 1 (todos, –∑–∞–º–µ—Ç–∫–∏)
     ‚îÇ   ‚îú‚îÄ‚îÄ agent_2.md      # –§–∞–π–ª –∞–≥–µ–Ω—Ç–∞ 2
     ‚îÇ   ‚îî‚îÄ‚îÄ ...
     ‚îî‚îÄ‚îÄ items/               # –ó–∞–º–µ—Ç–∫–∏ –∞–≥–µ–Ω—Ç–æ–≤ —Å –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º–∏
         ‚îú‚îÄ‚îÄ item_1.md
         ‚îî‚îÄ‚îÄ ...
     ```

#### –≠—Ç–∞–ø 3: –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è

7. **–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∞–≥–µ–Ω—Ç–æ–≤** (`execute_agents_enhanced_node`)

   **–õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã –∞–≥–µ–Ω—Ç–æ–≤:**
   
   - –ö–∞–∂–¥—ã–π –∞–≥–µ–Ω—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ **ReAct-—Å—Ç–∏–ª–µ** (Reasoning + Acting)
   - –ê–≥–µ–Ω—Ç—ã —Ä–∞–±–æ—Ç–∞—é—Ç **–ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ**, –∫–∞–∂–¥—ã–π –Ω–∞–¥ —Å–≤–æ–µ–π –∑–∞–¥–∞—á–µ–π
   - –û–¥–∏–Ω –∞–≥–µ–Ω—Ç = –æ–¥–Ω–∞ –∑–∞–¥–∞—á–∞ –∑–∞ —Ä–∞–∑ (enforced –≤ –∫–æ–¥–µ)
   - –ú–∞–∫—Å–∏–º—É–º —à–∞–≥–æ–≤ –Ω–∞ –∑–∞–¥–∞—á—É: 5 (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ `deep_research_agent_max_steps`, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 5, –±—ã–ª–æ 8)
   
   **–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –∞–≥–µ–Ω—Ç–æ–≤:**
   - `web_search(query: str)` - –≤–µ–±-–ø–æ–∏—Å–∫
     - –ü—Ä–∏–Ω–∏–º–∞–µ—Ç –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å (–∫–∞–∫ –≤ –±—Ä–∞—É–∑–µ—Ä–µ)
     - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å `title`, `url`, `snippet`
   - `scrape_url(urls: list[str])` - —Å–∫—Ä–∞–ø–∏–Ω–≥ URL
     - –ü—Ä–∏–Ω–∏–º–∞–µ—Ç —Å–ø–∏—Å–æ–∫ URL
     - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–∫—Ä–∞–ø–ª–µ–Ω–Ω—ã–π –∏ —Å—É–º–º–∞—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç
   - `done()` - —Å–∏–≥–Ω–∞–ª –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–∞–¥–∞—á–∏
   
   **–ü—Ä–æ—Ü–µ—Å—Å —Ä–∞–±–æ—Ç—ã –∞–≥–µ–Ω—Ç–∞:**
   ```
   1. –ê–≥–µ–Ω—Ç –ø–æ–ª—É—á–∞–µ—Ç –∑–∞–¥–∞—á—É (todo) –æ—Ç —Å—É–ø–µ—Ä–≤–∞–π–∑–µ—Ä–∞
   2. –ê–≥–µ–Ω—Ç –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∑–∞–¥–∞—á—É –∏ –ø–ª–∞–Ω–∏—Ä—É–µ—Ç –ø–æ–¥—Ö–æ–¥
   3. –ê–≥–µ–Ω—Ç –≤—ã–ø–æ–ª–Ω—è–µ—Ç –ø–æ–∏—Å–∫/—Å–∫—Ä–∞–ø–∏–Ω–≥
   4. –ê–≥–µ–Ω—Ç –æ—Ü–µ–Ω–∏–≤–∞–µ—Ç —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
   5. –ï—Å–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –Ω–µ—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã - –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å (–º–∞–∫—Å–∏–º—É–º 5 –ø–æ–ø—ã—Ç–æ–∫)
   6. –ê–≥–µ–Ω—Ç —Å–æ–∑–¥–∞–µ—Ç –∑–∞–º–µ—Ç–∫—É —Å –Ω–∞—Ö–æ–¥–∫–∞–º–∏ (—Ç–æ–ª—å–∫–æ –≤–∞–∂–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è, –Ω–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ)
   7. –ê–≥–µ–Ω—Ç —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –∑–∞–º–µ—Ç–∫—É –≤ items/ –∏ –≤ —Å–≤–æ–π —Ñ–∞–π–ª agents/{agent_id}.md
   8. –ê–≥–µ–Ω—Ç –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å todo –Ω–∞ "done"
   9. –ê–≥–µ–Ω—Ç —Å–∏–≥–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Å—É–ø–µ—Ä–≤–∞–π–∑–µ—Ä—É —á–µ—Ä–µ–∑ SupervisorQueue
   ```
   
   **–ü–∞–º—è—Ç—å –∞–≥–µ–Ω—Ç–∞:**
   - –ê–≥–µ–Ω—Ç –≤–∏–¥–∏—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 –≤–∞–∂–Ω—ã—Ö –∑–∞–º–µ—Ç–æ–∫ –∏–∑ —Å–≤–æ–µ–≥–æ —Ñ–∞–π–ª–∞ (–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–æ –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞)
   - –ê–≥–µ–Ω—Ç –≤–∏–¥–∏—Ç –∫–ª—é—á–µ–≤—ã–µ –∏–Ω—Å–∞–π—Ç—ã –∏–∑ `main.md`
   - –ê–≥–µ–Ω—Ç –≤–∏–¥–∏—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç: –∏—Å—Ö–æ–¥–Ω—ã–π –∑–∞–ø—Ä–æ—Å, deep search —Ä–µ–∑—É–ª—å—Ç–∞—Ç, –æ—Ç–≤–µ—Ç—ã –Ω–∞ —É—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã
   - **–í–ê–ñ–ù–û**: –ê–≥–µ–Ω—Ç—ã –ù–ï –≤–∏–¥—è—Ç –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞ - —Ç–æ–ª—å–∫–æ –∏—Å—Ö–æ–¥–Ω—ã–π –∑–∞–ø—Ä–æ—Å –∏ clarification answers
   
   **–†–µ—Ñ–ª–µ–∫—Å–∏—è –∞–≥–µ–Ω—Ç–∞:**
   - –ö–∞–∂–¥—ã–µ 3 —à–∞–≥–∞ –∞–≥–µ–Ω—Ç —Ä–µ—Ñ–ª–µ–∫—Å–∏—Ä—É–µ—Ç
   - –ú–æ–∂–µ—Ç –ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥—Ö–æ–¥, –µ—Å–ª–∏ —Ç–µ–∫—É—â–∏–π –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
   - –ú–æ–∂–µ—Ç –∑–∞–ø—Ä–æ—Å–∏—Ç—å –ø–æ–º–æ—â—å —É —Å—É–ø–µ—Ä–≤–∞–π–∑–µ—Ä–∞

8. **–ö–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏—è —á–µ—Ä–µ–∑ SupervisorQueue**

   **–õ–æ–≥–∏–∫–∞ –æ—á–µ—Ä–µ–¥–∏:**
   - –ö–æ–≥–¥–∞ –∞–≥–µ–Ω—Ç –∑–∞–≤–µ—Ä—à–∞–µ—Ç –∑–∞–¥–∞—á—É, –æ–Ω –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ –æ—á–µ—Ä–µ–¥—å
   - –°—É–ø–µ—Ä–≤–∞–π–∑–µ—Ä –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—á–µ—Ä–µ–¥—å –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ
   - –ü–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∞–≥–µ–Ω—Ç –ø–æ–ª—É—á–∞–µ—Ç –Ω–æ–≤—É—é –∑–∞–¥–∞—á—É –∏–ª–∏ –∑–∞–≤–µ—Ä—à–∞–µ—Ç —Ä–∞–±–æ—Ç—É
   
   **–ú–∞–∫—Å–∏–º—É–º –≤—ã–∑–æ–≤–æ–≤ —Å—É–ø–µ—Ä–≤–∞–π–∑–µ—Ä–∞:** 6 (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ `deep_research_max_supervisor_calls`, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 6, –±—ã–ª–æ 10)
   - –ü–æ—Å–ª–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –ª–∏–º–∏—Ç–∞ –∞–≥–µ–Ω—Ç—ã –ø—Ä–æ–¥–æ–ª–∂–∞—é—Ç —Ä–∞–±–æ—Ç—É –±–µ–∑ –≤—ã–∑–æ–≤–∞ —Å—É–ø–µ—Ä–≤–∞–π–∑–µ—Ä–∞
   - –ê–≥–µ–Ω—Ç—ã –∑–∞–≤–µ—Ä—à–∞—é—Ç –≤—Å–µ —Å–≤–æ–∏ –∑–∞–¥–∞—á–∏
   - –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–æ–±–∏—Ä–∞—é—Ç—Å—è –∏ –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è –≤ —á–µ—Ä–Ω–æ–≤–∏–∫ –æ—Ç—á–µ—Ç–∞

9. **–°—É–ø–µ—Ä–≤–∞–π–∑–µ—Ä –∫–æ–æ—Ä–¥–∏–Ω–∏—Ä—É–µ—Ç** (`supervisor_review_enhanced_node`)

   **–†–æ–ª—å —Å—É–ø–µ—Ä–≤–∞–π–∑–µ—Ä–∞:**
   - –ü—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞–µ—Ç –Ω–∞—Ö–æ–¥–∫–∏ –∞–≥–µ–Ω—Ç–æ–≤
   - –ò–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç –ø—Ä–æ–±–µ–ª—ã –≤ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–∏
   - –°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏ –¥–ª—è –∞–≥–µ–Ω—Ç–æ–≤
   - –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ –ø–æ–∫—Ä—ã—Ç–∏—è —Ç–µ–º—ã
   - –£–ø—Ä–∞–≤–ª—è–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞–º–∏ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è
   
   **–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã —Å—É–ø–µ—Ä–≤–∞–π–∑–µ—Ä–∞:**
   - `read_supervisor_file()` - —á–∏—Ç–∞–µ—Ç —Å–≤–æ–∏ –ª–∏—á–Ω—ã–µ –∑–∞–º–µ—Ç–∫–∏
   - `write_supervisor_note()` - –ø–∏—à–µ—Ç –∑–∞–º–µ—Ç–∫–∏ –≤ —Å–≤–æ–π —Ñ–∞–π–ª
   - `read_main_document()` - —á–∏—Ç–∞–µ—Ç –≥–ª–∞–≤–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç (—Ç–æ–ª—å–∫–æ –∫–ª—é—á–µ–≤—ã–µ –∏–Ω—Å–∞–π—Ç—ã)
   - `write_main_document()` - –¥–æ–±–∞–≤–ª—è–µ—Ç –∫–ª—é—á–µ–≤—ã–µ –∏–Ω—Å–∞–π—Ç—ã –≤ –≥–ª–∞–≤–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç
   - `read_draft_report()` - —á–∏—Ç–∞–µ—Ç —á–µ—Ä–Ω–æ–≤–∏–∫ –æ—Ç—á–µ—Ç–∞
   - `write_draft_report()` - –ø–∏—à–µ—Ç/–¥–æ–ø–æ–ª–Ω—è–µ—Ç —á–µ—Ä–Ω–æ–≤–∏–∫ –æ—Ç—á–µ—Ç–∞
   - `review_agent_progress()` - –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∞–≥–µ–Ω—Ç–∞
   - `create_agent_todo()` - —Å–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—É—é –∑–∞–¥–∞—á—É –¥–ª—è –∞–≥–µ–Ω—Ç–∞
   - `make_final_decision()` - –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Ä–µ—à–µ–Ω–∏–µ: –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å/–ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å/–∑–∞–≤–µ—Ä—à–∏—Ç—å
   
   **–ü—Ä–æ—Ü–µ—Å—Å —Ä–∞–±–æ—Ç—ã —Å—É–ø–µ—Ä–≤–∞–π–∑–µ—Ä–∞:**
   ```
   1. –°—É–ø–µ—Ä–≤–∞–π–∑–µ—Ä –ø–æ–ª—É—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –∑–∞–¥–∞—á–∏ –∞–≥–µ–Ω—Ç–∞
   2. –°—É–ø–µ—Ä–≤–∞–π–∑–µ—Ä —á–∏—Ç–∞–µ—Ç –Ω–∞—Ö–æ–¥–∫–∏ –∞–≥–µ–Ω—Ç–∞
   3. –°—É–ø–µ—Ä–≤–∞–π–∑–µ—Ä –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –Ω–∞—Ö–æ–¥–∫–∏ –Ω–∞ –≥–ª—É–±–∏–Ω—É –∏ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å
   4. –°—É–ø–µ—Ä–≤–∞–π–∑–µ—Ä –ø–∏—à–µ—Ç –∑–∞–º–µ—Ç–∫–∏ –≤ supervisor.md
   5. –°—É–ø–µ—Ä–≤–∞–π–∑–µ—Ä —Å–∏–Ω—Ç–µ–∑–∏—Ä—É–µ—Ç –Ω–∞—Ö–æ–¥–∫–∏ –≤ draft_report.md
   6. –°—É–ø–µ—Ä–≤–∞–π–∑–µ—Ä –¥–æ–±–∞–≤–ª—è–µ—Ç –∫–ª—é—á–µ–≤—ã–µ –∏–Ω—Å–∞–π—Ç—ã –≤ main.md
   7. –°—É–ø–µ—Ä–≤–∞–π–∑–µ—Ä –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–æ–∫—Ä—ã—Ç–∏–µ —Ç–µ–º—ã:
      - –ï—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–æ–±–µ–ª—ã - —Å–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏
      - –ï—Å–ª–∏ –Ω–∞—Ö–æ–¥–∫–∏ –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–Ω—ã–µ - —Å–æ–∑–¥–∞–µ—Ç –∑–∞–¥–∞—á–∏ –¥–ª—è —É–≥–ª—É–±–ª–µ–Ω–∏—è
      - –ï—Å–ª–∏ –∞–≥–µ–Ω—Ç—ã –¥—É–±–ª–∏—Ä—É—é—Ç —Ä–∞–±–æ—Ç—É - –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞ —Ä–∞–∑–Ω—ã–µ –∞—Å–ø–µ–∫—Ç—ã
   8. –°—É–ø–µ—Ä–≤–∞–π–∑–µ—Ä –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Ä–µ—à–µ–Ω–∏–µ:
      - "continue" - –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ (–µ—Å—Ç—å –Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏)
      - "replan" - –ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å (–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –Ω–µ–≤–µ—Ä–Ω–æ–µ)
      - "finish" - –∑–∞–≤–µ—Ä—à–∏—Ç—å (–∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø–æ–ª–Ω–æ–µ)
   ```
   
   **–ú–∞–∫—Å–∏–º—É–º –∏—Ç–µ—Ä–∞—Ü–∏–π —Å—É–ø–µ—Ä–≤–∞–π–∑–µ—Ä–∞:** 10 (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ `deep_research_supervisor_max_iterations`, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 10, –±—ã–ª–æ 15)
   - –ï—Å–ª–∏ —Å—É–ø–µ—Ä–≤–∞–π–∑–µ—Ä –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã 2 —Ä–∞–∑–∞ –ø–æ–¥—Ä—è–¥ - –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ
   - –ï—Å–ª–∏ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç –∏—Ç–µ—Ä–∞—Ü–∏–π - –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ
   
   **–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è —Å—É–ø–µ—Ä–≤–∞–π–∑–µ—Ä–∞:**
   - –ò—Å—Ö–æ–¥–Ω—ã–π –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   - –†–µ–∑—É–ª—å—Ç–∞—Ç –Ω–∞—á–∞–ª—å–Ω–æ–≥–æ deep search
   - –û—Ç–≤–µ—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ —É—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã
   - –í—Å–µ –Ω–∞—Ö–æ–¥–∫–∏ –∞–≥–µ–Ω—Ç–æ–≤ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 15 –ø–æ–ª–µ–∑–Ω—ã—Ö –Ω–∞—Ö–æ–¥–æ–∫)
   - **–í–ê–ñ–ù–û**: –°—É–ø–µ—Ä–≤–∞–π–∑–µ—Ä –ù–ï –≤–∏–¥–∏—Ç –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞ - —Ç–æ–ª—å–∫–æ –∏—Å—Ö–æ–¥–Ω—ã–π –∑–∞–ø—Ä–æ—Å –∏ clarification answers

#### –≠—Ç–∞–ø 4: –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞

10. **–°–∂–∞—Ç–∏–µ –Ω–∞—Ö–æ–¥–æ–∫** (`compress_findings_node`)
    - –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –≤—Å–µ—Ö –Ω–∞—Ö–æ–¥–æ–∫ –∞–≥–µ–Ω—Ç–æ–≤
    - –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è
    - –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –∏ –º—É—Å–æ—Ä–∞
    - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –≤–∞–∂–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏

11. **–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞** (`generate_final_report_enhanced_node`)
    
    **–ò—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–ª—è –æ—Ç—á–µ—Ç–∞:**
    - `draft_report.md` (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç) - —á–µ—Ä–Ω–æ–≤–∏–∫, —Å–æ–∑–¥–∞–Ω–Ω—ã–π —Å—É–ø–µ—Ä–≤–∞–π–∑–µ—Ä–æ–º
    - `main.md` (fallback) - –≥–ª–∞–≤–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç —Å –∫–ª—é—á–µ–≤—ã–º–∏ –∏–Ω—Å–∞–π—Ç–∞–º–∏
    - `all_findings` (fallback) - –≤—Å–µ –Ω–∞—Ö–æ–¥–∫–∏ –∞–≥–µ–Ω—Ç–æ–≤
    
    **–ü—Ä–æ—Ü–µ—Å—Å:**
    1. –ß—Ç–µ–Ω–∏–µ `draft_report.md`
    2. –ï—Å–ª–∏ —á–µ—Ä–Ω–æ–≤–∏–∫ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π (< 1000 —Å–∏–º–≤–æ–ª–æ–≤) –∏–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç - —Å–æ–∑–¥–∞–Ω–∏–µ –∏–∑ –≤—Å–µ—Ö –Ω–∞—Ö–æ–¥–æ–∫ (–±–µ–∑ –æ–±—Ä–µ–∑–∫–∏)
    3. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞ —á–µ—Ä–µ–∑ LLM:
       - Executive Summary (200-400 —Å–ª–æ–≤)
       - Sections (–º–∏–Ω–∏–º—É–º 3 —Å–µ–∫—Ü–∏–∏, –∫–∞–∂–¥–∞—è 300-800 —Å–ª–æ–≤)
       - Conclusion (200-400 —Å–ª–æ–≤)
    4. –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–ª–∏–Ω—ã –æ—Ç—á–µ—Ç–∞ (–º–∏–Ω–∏–º—É–º 1500 —Å–∏–º–≤–æ–ª–æ–≤)
    5. –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ Markdown —Å —Ü–∏—Ç–∞—Ç–∞–º–∏ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
    6. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è PDF —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π UTF-8 –∫–æ–¥–∏—Ä–æ–≤–∫–æ–π
    7. –ö–Ω–æ–ø–∫–∞ —Å–∫–∞—á–∞—Ç—å PDF –ø–æ—è–≤–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è deep research
    
    **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç—á–µ—Ç–∞:**
    ```python
    class FinalReport:
        executive_summary: str  # 200-400 —Å–ª–æ–≤
        sections: list[ReportSection]  # –ú–∏–Ω–∏–º—É–º 3 —Å–µ–∫—Ü–∏–∏
        conclusion: str  # 200-400 —Å–ª–æ–≤
        sources: list[str]  # –°–ø–∏—Å–æ–∫ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
    
    class ReportSection:
        title: str
        content: str  # 300-800 —Å–ª–æ–≤, markdown
    ```

12. **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏ –≤–æ–∑–≤—Ä–∞—Ç**
    - –û—Ç—á–µ—Ç —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ —Å–µ—Å—Å–∏–æ–Ω–Ω—É—é –ø–∞–ø–∫—É
    - –û—Ç—á–µ—Ç —Å—Ç—Ä–∏–º–∏—Ç—Å—è –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ —á–µ—Ä–µ–∑ SSE
    - –°–µ—Å—Å–∏–æ–Ω–Ω–∞—è –ø–∞–ø–∫–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
    - –û—á–∏—Å—Ç–∫–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –æ—à–∏–±–∫–µ –∏–ª–∏ –æ—Ç–º–µ–Ω–µ

### –ü–∞—Ä–∞–º–µ—Ç—Ä—ã Deep Research

**–ù–∞—Å—Ç—Ä–æ–π–∫–∏ (–≤ `backend/.env`):**
```bash
# –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–≥–µ–Ω—Ç–æ–≤
DEEP_RESEARCH_NUM_AGENTS=4

# –ú–∞–∫—Å–∏–º—É–º –≤—ã–∑–æ–≤–æ–≤ —Å—É–ø–µ—Ä–≤–∞–π–∑–µ—Ä–∞
DEEP_RESEARCH_MAX_SUPERVISOR_CALLS=6

# –ú–∞–∫—Å–∏–º—É–º —à–∞–≥–æ–≤ –Ω–∞ –∑–∞–¥–∞—á—É –¥–ª—è –∞–≥–µ–Ω—Ç–∞
DEEP_RESEARCH_AGENT_MAX_STEPS=5

# –ú–∞–∫—Å–∏–º—É–º –∏—Ç–µ—Ä–∞—Ü–∏–π ReAct –¥–ª—è —Å—É–ø–µ—Ä–≤–∞–π–∑–µ—Ä–∞
DEEP_RESEARCH_SUPERVISOR_MAX_ITERATIONS=10

# –ú–∞–∫—Å–∏–º—É–º –∏—Ç–µ—Ä–∞—Ü–∏–π —Ü–∏–∫–ª–∞ –∞–≥–µ–Ω—Ç–æ–≤
DEEP_RESEARCH_DEFAULT_MAX_ITERATIONS=15  # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: 15 (–±—ã–ª–æ 25)

# –í—ã–ø–æ–ª–Ω—è—Ç—å deep search –≤ –Ω–∞—á–∞–ª–µ
DEEP_RESEARCH_RUN_DEEP_SEARCH_FIRST=true

# –ó–∞–¥–∞–≤–∞—Ç—å —É—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã
DEEP_RESEARCH_ENABLE_CLARIFYING_QUESTIONS=true
```

### –ü–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö Deep Research

```
User Query ‚Üí Deep Search (optional) ‚Üí Clarifying Questions (optional) ‚Üí
Analyze Query ‚Üí Plan Research ‚Üí Create Agent Characteristics ‚Üí
Execute Agents (parallel) ‚Üí Supervisor Reviews ‚Üí 
[Continue/Replan/Finish] ‚Üí
Compress Findings ‚Üí Generate Final Report ‚Üí Return
```

### –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ Deep Research

- **–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞ –∞–≥–µ–Ω—Ç–æ–≤** - –Ω–µ—Å–∫–æ–ª—å–∫–æ –∞–≥–µ–Ω—Ç–æ–≤ —Ä–∞–±–æ—Ç–∞—é—Ç –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
- **–ö–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏—è —á–µ—Ä–µ–∑ –æ—á–µ—Ä–µ–¥—å** - —Å—É–ø–µ—Ä–≤–∞–π–∑–µ—Ä –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ
- **–î–∏–≤–µ—Ä—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –∑–∞–¥–∞—á** - —Å—É–ø–µ—Ä–≤–∞–π–∑–µ—Ä –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –ø–æ–∫—Ä—ã—Ç–∏–µ —Ä–∞–∑–Ω—ã—Ö –∞—Å–ø–µ–∫—Ç–æ–≤ —Ç–µ–º—ã
- **–ì–ª—É–±–æ–∫–∞—è —Ä–µ—Ñ–ª–µ–∫—Å–∏—è** - –∞–≥–µ–Ω—Ç—ã –∏ —Å—É–ø–µ—Ä–≤–∞–π–∑–µ—Ä —Ä–µ—Ñ–ª–µ–∫—Å–∏—Ä—É—é—Ç –∏ –ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä—É—é—Ç
- **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç—å—é** - —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –∑–∞–º–µ—Ç–æ–∫ –∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
- **–ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç—á–µ—Ç** - –¥–∞–∂–µ –ø—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–æ–≤ —Å–æ–∑–¥–∞–µ—Ç—Å—è —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç
- **–Ø–∑—ã–∫–æ–≤–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞** - –∞–≥–µ–Ω—Ç—ã –∏ —Å—É–ø–µ—Ä–≤–∞–π–∑–µ—Ä —Ä–∞–±–æ—Ç–∞—é—Ç –Ω–∞ —è–∑—ã–∫–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

---

## –°—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ —Ä–µ–∂–∏–º–æ–≤

| –ü–∞—Ä–∞–º–µ—Ç—Ä | Chat | Web Search | Deep Search | Deep Research |
|----------|------|------------|-------------|---------------|
| –í–µ–±-–ø–æ–∏—Å–∫ | ‚ùå | ‚úÖ | ‚úÖ | ‚úÖ |
| –ò—Ç–µ—Ä–∞—Ü–∏–∏ –ø–æ–∏—Å–∫–∞ | 0 | 2 | 6 | –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ |
| –ê–≥–µ–Ω—Ç—ã | 0 | 0 | 0 | 1-5 |
| –°–∫—Ä–∞–ø–∏–Ω–≥ | ‚ùå | ‚úÖ (4 URL) | ‚úÖ (4 URL) | ‚úÖ (–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏) |
| –†–µ—Ä–∞–Ω–∂–∏–Ω–≥ | ‚ùå | ‚úÖ | ‚úÖ | ‚ùå |
| –ü–∞–º—è—Ç—å –∞–≥–µ–Ω—Ç–æ–≤ | ‚ùå | ‚ùå | ‚ùå | ‚úÖ |
| –£—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã | ‚ùå | ‚ùå | ‚ùå | ‚úÖ |
| –î–ª–∏–Ω–∞ –æ—Ç–≤–µ—Ç–∞ | –°—Ä–µ–¥–Ω—è—è | 400-600 —Å–ª–æ–≤ | 800-1200 —Å–ª–æ–≤ | 2000-5000+ —Å–ª–æ–≤ |
| –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è | < 5 —Å–µ–∫ | 10-30 —Å–µ–∫ | 30-60 —Å–µ–∫ | 2-10 –º–∏–Ω—É—Ç |
| –ò—Å—Ç–æ—á–Ω–∏–∫–∏ | 0 | 4-8 | 8-16 | 20-50+ |
| –ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞ | ‚úÖ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ N) | ‚úÖ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ N) | ‚úÖ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ N) | ‚ùå (—Ç–æ–ª—å–∫–æ –∏—Å—Ö–æ–¥–Ω—ã–π –∑–∞–ø—Ä–æ—Å + clarification) |
| PDF —ç–∫—Å–ø–æ—Ä—Ç | ‚ùå | ‚ùå | ‚ùå | ‚úÖ (–ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è) |

---

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–µ—Ç–∞–ª–∏

### –Ø–∑—ã–∫–æ–≤–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞

–í—Å–µ —Ä–µ–∂–∏–º—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è—é—Ç —è–∑—ã–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—á–µ—Ä–µ–∑ `langdetect`) –∏:
- –ì–µ–Ω–µ—Ä–∏—Ä—É—é—Ç –æ—Ç–≤–µ—Ç—ã –Ω–∞ —è–∑—ã–∫–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –ò—Å–ø–æ–ª—å–∑—É—é—Ç —è–∑—ã–∫ –≤ –ø—Ä–æ–º–ø—Ç–∞—Ö –¥–ª—è –∞–≥–µ–Ω—Ç–æ–≤
- –§–æ—Ä–º–∞—Ç–∏—Ä—É—é—Ç –≤—ã–≤–æ–¥ –Ω–∞ —è–∑—ã–∫–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

### Streaming (SSE –∏ Socket.IO)

–í—Å–µ —Ä–µ–∂–∏–º—ã –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç streaming –¥–ª—è:
- –†–µ–∞–ª—å–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ (—Å—Ç–∞—Ç—É—Å—ã, –∏—Å—Ç–æ—á–Ω–∏–∫–∏, –Ω–∞—Ö–æ–¥–∫–∏)
- –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ–π –ø–µ—Ä–µ–¥–∞—á–∏ –æ—Ç–≤–µ—Ç–∞ (chunks)
- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ —Å—Ç–∞—Ç—É—Å–µ (–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è, —ç—Ç–∞–ø—ã, –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ)
- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∑–∞–¥–∞—á –∞–≥–µ–Ω—Ç–æ–≤ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ (todos, notes)
- Socket.IO –¥–ª—è –¥–≤—É—Å—Ç–æ—Ä–æ–Ω–Ω–µ–π –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏
- PDF —ç–∫—Å–ø–æ—Ä—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (—Ç–æ–ª—å–∫–æ –¥–ª—è deep research –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è)

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø–æ–≤—Ç–æ—Ä—ã –ø—Ä–∏ —Å–±–æ—è—Ö (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ `max_structured_output_retries`)
- Fallback –º–µ—Ö–∞–Ω–∏–∑–º—ã –¥–ª—è –≤—Å–µ—Ö structured output –≤—ã–∑–æ–≤–æ–≤
- Graceful degradation –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö LLM
- –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ—à–∏–±–æ–∫ —Å –ø–æ–ª–Ω—ã–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
- –£–ª—É—á—à–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ None/undefined –æ—Ç–≤–µ—Ç–æ–≤ –æ—Ç LLM
- –ó–∞—â–∏—Ç–∞ –æ—Ç –æ—à–∏–±–æ–∫ undefined.length –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

- –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≥–¥–µ –≤–æ–∑–º–æ–∂–Ω–æ
- –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
- –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ LLM
- –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç—å—é

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã (–æ–±–Ω–æ–≤–ª–µ–Ω–æ 2026-01-12)

### Multi-Chat Support

–°–∏—Å—Ç–µ–º–∞ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç **–º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —á–∞—Ç—ã** (–∫–∞–∫ ChatGPT):

- **SessionManager** —É–ø—Ä–∞–≤–ª—è–µ—Ç —Å–µ—Å—Å–∏—è–º–∏ deep_research
- –ö–∞–∂–¥—ã–π chat_id –∏–º–µ–µ—Ç –º–∞–∫—Å–∏–º—É–º **1 –∞–∫—Ç–∏–≤–Ω—É—é deep_research —Å–µ—Å—Å–∏—é**
- –ü—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –º–µ–∂–¥—É —á–∞—Ç–∞–º–∏ —Å–µ—Å—Å–∏–∏ **—Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è**
- –ü—Ä–∏ —Å–º–µ–Ω–µ —Ä–µ–∂–∏–º–∞ –≤–Ω—É—Ç—Ä–∏ —á–∞—Ç–∞ —Å–µ—Å—Å–∏—è **—Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è** (–ø–æ–º–µ—á–∞–µ—Ç—Å—è "superseded")
- **Resume –º–µ—Ö–∞–Ω–∏–∑–º** —á–µ—Ä–µ–∑ LangGraph checkpoints –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –Ω–µ–∑–∞–≤–µ—Ä—à–µ–Ω–Ω–æ–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ

```python
# –ü—Ä–∏–º–µ—Ä —Ä–∞–±–æ—Ç—ã:
Chat A: deep_research ‚Üí clarification ‚Üí switch to Chat B
Chat B: search mode ‚Üí switch back to Chat A
Chat A: user answers clarification ‚Üí research CONTINUES (resume)
```

### Session-Based Architecture

**–ë—ã–ª–æ (–ø—Ä–æ–±–ª–µ–º–Ω–æ):**
- –ü–æ–∏—Å–∫ original_query —á–µ—Ä–µ–∑ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –º–∞—Ä–∫–µ—Ä—ã ("clarification", "üîç")
- O(n¬≤) —Å–ª–æ–∂–Ω–æ—Å—Ç—å –ø–æ–∏—Å–∫–∞ –ø–æ chat_history
- –•—Ä—É–ø–∫–∞—è –ª–æ–≥–∏–∫–∞, –∑–∞–≤–∏—Å–∏–º–∞—è –æ—Ç —Ç–µ–∫—Å—Ç–∞

**–°—Ç–∞–ª–æ (–Ω–∞–¥–µ–∂–Ω–æ):**
- `original_query` —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ —Ç–∞–±–ª–∏—Ü–µ `research_sessions` —Å—Ä–∞–∑—É
- O(1) –¥–æ—Å—Ç—É–ø –∏–∑ –ë–î —á–µ—Ä–µ–∑ session_id
- `session_status` (active, waiting_clarification, researching, completed) –≤–º–µ—Å—Ç–æ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –º–∞—Ä–∫–µ—Ä–æ–≤
- –°—Ç–∞–±–∏–ª—å–Ω—ã–π session_id –¥–ª—è checkpoint resume

### –ú–æ–¥—É–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –Ω–æ–¥

**–ë—ã–ª–æ:**
- nodes.py (2162 —Å—Ç—Ä–æ–∫–∏) - –º–æ–Ω–æ–ª–∏—Ç–Ω—ã–π —Ñ–∞–π–ª
- Runtime dependencies —á–µ—Ä–µ–∑ context variables

**–°—Ç–∞–ª–æ:**
```
nodes/
‚îú‚îÄ‚îÄ base.py              # ResearchNode base class
‚îú‚îÄ‚îÄ deep_search.py       # –ù–∞—á–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
‚îú‚îÄ‚îÄ clarify.py           # –£—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã
‚îú‚îÄ‚îÄ analyze.py           # –ê–Ω–∞–ª–∏–∑ –∑–∞–ø—Ä–æ—Å–∞
‚îú‚îÄ‚îÄ plan.py              # –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è
‚îú‚îÄ‚îÄ spawn_agents.py      # –°–æ–∑–¥–∞–Ω–∏–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫ –∞–≥–µ–Ω—Ç–æ–≤
‚îú‚îÄ‚îÄ execute_agents.py    # –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∞–≥–µ–Ω—Ç–æ–≤
‚îú‚îÄ‚îÄ supervisor_review.py # –ö–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏—è —Å—É–ø–µ—Ä–≤–∞–π–∑–µ—Ä–∞
‚îú‚îÄ‚îÄ compress.py          # –°–∂–∞—Ç–∏–µ –Ω–∞—Ö–æ–¥–æ–∫
‚îî‚îÄ‚îÄ report.py            # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞
```

### Dependency Injection

**–ë—ã–ª–æ:**
```python
runtime_deps_context = contextvars.ContextVar('runtime_deps')
state = _restore_runtime_deps(state)
```

**–°—Ç–∞–ª–æ:**
```python
@dataclass
class ResearchDependencies:
    llm: Any
    search_provider: Any
    session_manager: SessionManager
    # ... –¥—Ä—É–≥–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

class ResearchNode(ABC):
    def __init__(self, deps: ResearchDependencies):
        self.deps = deps
```

### Prompt Builders

–í—Å–µ –ø—Ä–æ–º–ø—Ç—ã –≤—ã–Ω–µ—Å–µ–Ω—ã –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–µ –º–æ–¥—É–ª–∏:

```
prompts/
‚îú‚îÄ‚îÄ base.py              # PromptBuilder base —Å utilities
‚îú‚îÄ‚îÄ supervisor.py        # Supervisor prompts
‚îú‚îÄ‚îÄ agent.py             # Research agent prompts
‚îú‚îÄ‚îÄ clarify.py           # Clarification prompts
‚îú‚îÄ‚îÄ analysis.py          # Query analysis prompts
‚îú‚îÄ‚îÄ planning.py          # Research planning prompts
‚îî‚îÄ‚îÄ report.py            # Final report prompts
```

### Database Schema

**–ù–æ–≤—ã–µ —Ç–∞–±–ª–∏—Ü—ã:**

```sql
CREATE TABLE research_sessions (
    id VARCHAR(64) PRIMARY KEY,
    chat_id VARCHAR(64) NOT NULL,  -- FK to chats
    original_query TEXT NOT NULL,
    mode VARCHAR(16) NOT NULL,
    status VARCHAR(32) NOT NULL,
    deep_search_result TEXT,
    clarification_answers TEXT,
    draft_report TEXT,
    final_report TEXT
    -- UNIQUE INDEX –¥–ª—è 1 –∞–∫—Ç–∏–≤–Ω–æ–π —Å–µ—Å—Å–∏–∏ –Ω–∞ chat_id
);
```

### Routing Logic

**session_status-based routing (–≤–º–µ—Å—Ç–æ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –º–∞—Ä–∫–µ—Ä–æ–≤):**

```python
def should_ask_clarification(state: ResearchState) -> str:
    session_status = state.get("session_status", "active")

    if session_status == "waiting_clarification":
        has_user_answer = chat_history[-1].get("role") == "user"
        return "proceed" if has_user_answer else "wait_for_user"

    return "proceed"
```

### Workflow Resume

```python
# –í chat_stream.py
session, is_new = await session_manager.get_or_create_session(
    chat_id=request.chat_id,
    query=current_user_message,
    mode=mode
)

# –ï—Å–ª–∏ is_new == False, —ç—Ç–æ resume
if not is_new:
    # LangGraph –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–∞–µ—Ç checkpoint –ø–æ session_id
    logger.info("Resuming from checkpoint")
```

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –Ω–æ–≤–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

‚úÖ **Multi-chat support** - –∏–∑–æ–ª—è—Ü–∏—è —Å–µ—Å—Å–∏–π –ø–æ chat_id
‚úÖ **Session resume** - –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –Ω–µ–∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–π
‚úÖ **O(1) original_query** - –∏–∑ –ë–î –≤–º–µ—Å—Ç–æ O(n¬≤) –ø–æ–∏—Å–∫–∞
‚úÖ **–£—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å** - session_status –≤–º–µ—Å—Ç–æ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –º–∞—Ä–∫–µ—Ä–æ–≤
‚úÖ **–ú–æ–¥—É–ª—å–Ω–æ—Å—Ç—å** - –ª–µ–≥–∫–æ –Ω–∞–π—Ç–∏ –∏ –∏–∑–º–µ–Ω–∏—Ç—å –∫–æ–¥
‚úÖ **–¢–µ—Å—Ç–∏—Ä—É–µ–º–æ—Å—Ç—å** - –∫–∞–∂–¥–∞—è –Ω–æ–¥–∞ –Ω–µ–∑–∞–≤–∏—Å–∏–º–∞
‚úÖ **DI pattern** - —è–≤–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

