# Архитектура агентной системы и пайплайны работы

## Обзор

Система использует многоагентную архитектуру с иерархической структурой: **Supervisor** (супервайзер) координирует работу множества **Researcher** (исследовательских) агентов. Каждый агент работает в ReAct-стиле (Reasoning + Acting), используя структурированный вывод для принятия решений.

## Компоненты системы

### 1. AgenticSupervisor (Супервайзер)

**Роль:** Координатор, который планирует задачи, управляет исследователями и контролирует общий прогресс проекта.

**Основные функции:**
- Генерация начальных исследовательских задач (`initial_tasks`)
- Анализ пробелов в исследованиях и генерация дополнительных задач (`gap_tasks`)
- ReAct-цикл: пробуждение после каждого действия подчиненных агентов
- Управление файлами агентов (чтение, обновление todo-листов)
- Запись статуса проекта в `main.md`

**Инструменты:**
- `plan_tasks` - планирование исследовательских задач
- `create_agent` - создание нового агента с характером и предпочтениями
- `read_agent_file` - чтение файла агента для проверки прогресса
- `update_agent_todo` - обновление todo-листа любого агента
- `write_to_main` - запись в главный файл памяти `main.md`
- `read_main` - чтение `main.md`
- `read_note` - чтение конкретной заметки
- `write_note` - создание заметки от имени супервайзера

**Структурированный вывод:**
- `SupervisorTasks` - для планирования задач
- `SupervisorAction` - для ReAct-действий

### 2. AgenticResearcher (Исследовательские агенты)

**Роль:** Специализированные агенты, которые проводят глубокое исследование конкретных тем.

**Основные функции:**
- Поиск информации в интернете
- Скрапинг веб-страниц
- Прокрутка страниц для загрузки динамического контента
- Создание и обновление заметок
- Управление личным todo-листом
- Чтение общих заметок других агентов
- Работа с персональным файлом агента

**Инструменты:**

#### Поиск и сбор информации
- `web_search` - веб-поиск по запросам
  - Параметры: `queries` (список), `max_results` (int)
  - Результат: список источников с URL и заголовками
  
- `scrape_urls` - скрапинг содержимого страниц
  - Параметры: `urls` (список), `scroll` (bool, опционально)
  - Результат: извлеченный текст и заголовки
  
- `scroll_page` - прокрутка страницы для загрузки динамического контента
  - Параметры: `url` (str), `scrolls` (int, по умолчанию 3), `pause` (float, по умолчанию 1.0)
  - Результат: информация об увеличении высоты страницы и видимом контенте в viewport

#### Работа с заметками
- `write_note` - создание заметки
  - Параметры: `title`, `summary`, `urls`, `tags`, `share` (bool)
  - Сохраняется в `items/` и обновляет `main.md`
  
- `read_note` - чтение конкретной заметки
  - Параметры: `file_path` (например, `items/note_20241230.md`)
  
- `update_note` - обновление собственной заметки
  - Параметры: `file_path`, `summary`, `urls`
  - Ограничение: только свои заметки
  
- `read_shared_notes` - чтение общих заметок
  - Параметры: `keyword` (опционально), `limit` (int)

#### Работа с задачами (Todo List)
- `add_todo` - добавление задач
  - Параметры: `items` (список строк или объектов)
  
- `update_todo` - обновление задачи
  - Параметры: `title`, `status` (`pending|in_progress|done`), `note`
  
- `complete_todo` - завершение задач
  - Параметры: `titles` (список)

#### Работа с файлами
- `read_agent_file` - чтение личного файла агента
  - Параметры: `agent_id`
  
- `read_main` - чтение главного файла `main.md`
  - Параметры: нет
  - Доступен всем агентам

#### Завершение работы
- `finish` - завершение исследования
  - Параметры: нет

**Структурированный вывод:**
- `AgentAction` - для всех действий агента

### 3. AgenticResearchCoordinator

**Роль:** Оркестратор, который управляет циклами работы супервайзера и исследователей.

**Основные функции:**
- Инициализация супервайзера и исследователей
- Управление раундами исследований (до `max_rounds`)
- Ограничение количества параллельных агентов (`max_concurrent`)
- Сбор и агрегация результатов исследований
- Запись статуса проекта после каждого раунда

**Параметры:**
- `max_rounds`: максимальное количество раундов (по умолчанию 3)
- `max_concurrent`: максимальное количество параллельных агентов (по умолчанию 4)
- `max_sources`: максимальное количество источников на агента (по умолчанию 10)

## Пайплайны работы

### 1. Chat Mode (Простой диалог)

**Описание:** Простой LLM-диалог без веб-поиска.

**Пайплайн:**
```
User Query
    ↓
ChatService.answer_chat()
    ↓
LLM (с текущей датой в контексте)
    ↓
Ответ пользователю
```

**Особенности:**
- Нет веб-поиска
- Нет сохранения в память
- Быстрый ответ
- Использует историю чата

**Код:** `backend/src/chat/service.py::answer_chat()`

---

### 2. Search Mode (Веб-поиск)

**Описание:** Быстрый веб-поиск с синтезом ответа.

**Пайплайн:**
```
User Query
    ↓
ChatService.answer_web()
    ↓
[Опционально] Переформулировка запроса (_rewrite_query)
    ↓
Генерация поисковых запросов (_generate_search_queries)
    ↓
Веб-поиск (SearchProvider) → Результаты
    ↓
Скрапинг топ-N результатов (WebScraper)
    ↓
Семантический реранкинг (SemanticReranker)
    ↓
Суммаризация скрапированного контента (_summarize_scraped)
    ↓
Синтез финального ответа (_synthesize_answer)
    ↓
Ответ пользователю
```

**Особенности:**
- 1-3 поисковых запроса
- Скрапинг топ-5 результатов
- Реранкинг по семантической релевантности
- Быстрый ответ (30-60 секунд)

**Код:** `backend/src/chat/service.py::answer_web()`

---

### 3. Deep Search Mode (Глубокий поиск)

**Описание:** Многоитерационный веб-поиск с уточняющими запросами.

**Пайплайн:**
```
User Query
    ↓
ChatService.answer_deep()
    ↓
[Итерация 1]
    ├─ Генерация поисковых запросов
    ├─ Веб-поиск
    ├─ Скрапинг и реранкинг
    └─ Суммаризация
    ↓
[Итерация 2-N] (до 3 итераций)
    ├─ Анализ пробелов
    ├─ Генерация уточняющих запросов (_generate_followup_queries)
    ├─ Веб-поиск
    ├─ Скрапинг и реранкинг
    └─ Суммаризация
    ↓
Синтез финального ответа
    ↓
Ответ пользователю
```

**Особенности:**
- 2-3 итерации поиска
- Уточняющие запросы на основе предыдущих результатов
- Сессионная память для отслеживания найденной информации
- Более глубокий анализ (1-2 минуты)

**Код:** `backend/src/chat/service.py::answer_deep()`

---

### 4. Deep Research Mode (Глубокое исследование)

**Описание:** Многоагентное исследование с использованием Supervisor-Researcher архитектуры.

#### 4.1. Speed Mode (Быстрый режим)

**Пайплайн:**
```
User Query
    ↓
SpeedResearchWorkflow.run()
    ↓
[Node: search_memory]
    └─ Поиск в памяти (5 результатов)
    ↓
[Node: plan_research]
    └─ Планирование исследования (1 тема)
    ↓
[Node: quick_research]
    └─ Один исследователь на главной теме
    │   ├─ Веб-поиск
    │   ├─ Скрапинг
    │   └─ Анализ и синтез
    ↓
[Node: generate_report]
    └─ Генерация финального отчета
    ↓
Ответ пользователю
```

**Параметры:**
- Итераций: 2
- Параллельных агентов: 1
- Результатов из памяти: 5

**Код:** `backend/src/workflow/speed_research.py`

---

#### 4.2. Balanced Mode (Сбалансированный режим)

**Пайплайн:**
```
User Query
    ↓
BalancedResearchWorkflow.run()
    ↓
[Node: search_memory]
    └─ Поиск в памяти (10 результатов)
    ↓
[Node: plan_research]
    └─ Планирование исследования (до 3 тем)
    ↓
[Node: conduct_research]
    └─ Параллельное исследование (3 агента)
    │   ├─ Agent 1: Тема 1
    │   │   ├─ Веб-поиск
    │   │   ├─ Скрапинг
    │   │   └─ Анализ
    │   ├─ Agent 2: Тема 2
    │   │   ├─ Веб-поиск
    │   │   ├─ Скрапинг
    │   │   └─ Анализ
    │   └─ Agent 3: Тема 3
    │       ├─ Веб-поиск
    │       ├─ Скрапинг
    │       └─ Анализ
    ↓
[Node: generate_report]
    └─ Генерация финального отчета
    ↓
Ответ пользователю
```

**Параметры:**
- Итераций: 6
- Параллельных агентов: 3
- Результатов из памяти: 10

**Код:** `backend/src/workflow/balanced_research.py`

---

#### 4.3. Quality Mode (Режим качества)

**Пайплайн:**
```
User Query
    ↓
QualityResearchWorkflow.run()
    ↓
[Node: search_memory]
    └─ Поиск в памяти (20 результатов)
    ↓
[Node: plan_research]
    └─ Планирование исследования (до 5 тем)
    ↓
[Node: deep_research]
    └─ AgenticResearchCoordinator.run()
        │
        ├─ [Round 0]
        │   ├─ Supervisor.initial_tasks() → 4 задачи
        │   ├─ Параллельный запуск 4 исследователей:
        │   │   ├─ Agent r0_0: Тема 1
        │   │   │   ├─ ReAct цикл (до 6 шагов):
        │   │   │   │   ├─ web_search
        │   │   │   │   ├─ scrape_urls / scroll_page
        │   │   │   │   ├─ write_note
        │   │   │   │   ├─ update_todo
        │   │   │   │   └─ read_shared_notes
        │   │   │   └─ Синтез ResearchFinding
        │   │   ├─ Agent r0_1: Тема 2
        │   │   ├─ Agent r0_2: Тема 3
        │   │   └─ Agent r0_3: Тема 4
        │   ├─ Supervisor.write_project_status() → main.md
        │   └─ Сбор findings
        │
        ├─ [Round 1]
        │   ├─ Supervisor.gap_tasks() → новые задачи
        │   ├─ Параллельный запуск исследователей
        │   ├─ Supervisor.write_project_status()
        │   └─ Сбор findings
        │
        └─ [Round 2] (если нужно)
            └─ ...
    ↓
[Node: compress_findings]
    └─ Сжатие findings (структурированный вывод)
    ↓
[Node: generate_report]
    └─ Генерация финального отчета
    ↓
[Опционально] Сохранение в память
    ↓
Ответ пользователю
```

**Параметры:**
- Итераций: 25
- Параллельных агентов: 4
- Раундов: 3
- Шагов на агента: 6
- Результатов из памяти: 20

**Особенности:**
- Многоагентная архитектура с Supervisor
- ReAct-циклы для каждого исследователя
- Общая память (SharedResearchMemory)
- Персональные файлы агентов (`agents/{agent_id}.md`)
- Автоматическое обновление `main.md` после каждого раунда
- Сжатие findings перед генерацией отчета

**Код:** `backend/src/workflow/quality_research.py`, `backend/src/workflow/agentic/coordinator.py`

---

## Потоки данных

### Память агентов

**Структура:**
```
memory_files/
├── main.md              # Главный файл (читают все агенты)
├── items/               # Индивидуальные заметки
│   ├── note_20241230_agent_r0_0.md
│   └── ...
└── agents/              # Персональные файлы агентов
    ├── agent_r0_0.md    # Todo-лист, характер, предпочтения
    ├── agent_r0_1.md
    └── ...
```

**Доступ:**
- Все агенты читают `main.md` (первые 1000 символов в контексте, полный доступ через `read_main`)
- Агенты создают заметки в `items/` через `write_note`
- Каждый агент имеет персональный файл в `agents/` для todo-листа и заметок
- Supervisor может читать и обновлять файлы всех агентов

### Общая память (SharedResearchMemory)

**Хранение:**
- В памяти процесса (эпиhemeral)
- Синхронизируется с файловой системой через `AgentMemoryService`
- Заметки с `share=true` доступны всем агентам через `read_shared_notes`

### База данных

**Таблицы:**
- `memory_files` - файлы памяти
- `memory_chunks` - чанки с эмбеддингами для векторного поиска
- `chats` - чаты
- `chat_messages` - сообщения чатов

**Индексация:**
- Гибридный поиск (векторный + полнотекстовый) через `HybridSearchEngine`
- RRF (Reciprocal Rank Fusion) для ранжирования результатов

---

## ReAct-цикл исследователя

Каждый исследователь работает в ReAct-стиле:

```
1. Наблюдение (Observation)
   ├─ Чтение промпта с контекстом:
   │   ├─ Тема исследования
   │   ├─ Контекст памяти (memory_context)
   │   ├─ Общие заметки (shared_notes)
   │   ├─ Содержимое main.md (первые 1000 символов)
   │   ├─ Личный todo-лист
   │   ├─ Личные заметки
   │   ├─ Находки других агентов
   │   └─ Результат последнего действия
   │
   └─ LLM генерирует структурированный AgentAction

2. Действие (Action)
   └─ Выполнение инструмента:
       ├─ web_search → результаты поиска
       ├─ scrape_urls → скрапированный контент
       ├─ scroll_page → прокрутка и viewport контент
       ├─ write_note → сохранение заметки
       ├─ update_todo → обновление задачи
       └─ ...

3. Рефлексия (Reflection)
   └─ Результат действия передается в следующий цикл

4. Повторение (до max_steps или finish)
```

---

## Структурированный вывод

Все LLM-вызовы используют структурированный вывод через Pydantic-схемы:

- `AgentAction` - действия исследователя
- `SupervisorAction` - действия супервайзера
- `SupervisorTasks` - планирование задач
- `SearchQueries` - генерация поисковых запросов
- `ResearchAnalysis` - анализ результатов исследования
- `CompressedFindings` - сжатие findings
- `SynthesizedAnswer` - синтез ответа

**Метод:** `method="function_calling"` для совместимости с OpenAI API.

---

## Параллелизм

### Уровень Coordinator
- Параллельный запуск до `max_concurrent` агентов в каждом раунде
- Использует `asyncio.Semaphore` для ограничения параллелизма
- `asyncio.gather()` для сбора результатов

### Уровень Researcher
- Последовательные ReAct-циклы (до `max_steps`)
- Асинхронные вызовы инструментов (веб-поиск, скрапинг)

### Уровень Scraper
- Параллельный скрапинг нескольких URL
- Поддержка Playwright для JavaScript-рендеринга и прокрутки

---

## Стриминг

Все пайплайны поддерживают Server-Sent Events (SSE) для стриминга прогресса:

**События:**
- `init` - инициализация
- `status` - обновление статуса
- `memory_search` - результаты поиска в памяти
- `search_queries` - сгенерированные поисковые запросы
- `planning` - план исследования
- `source_found` - найденный источник
- `finding` - находка исследователя
- `agent_todo` - обновление todo-листа агента
- `agent_note` - новая заметка агента
- `report_chunk` - чанк финального отчета
- `final_report` - финальный отчет
- `error` - ошибка
- `done` - завершение

**Код:** `backend/src/api/streaming.py`

---

## Конфигурация

### Режимы работы

| Режим | Итераций | Агентов | Память | Время | Использование |
|-------|----------|---------|--------|-------|----------------|
| chat | 0 | 0 | - | <5s | Простой диалог |
| search | 1 | 0 | 5 | 30-60s | Быстрый ответ |
| deep_search | 2-3 | 0 | 10 | 1-2min | Глубокий поиск |
| speed | 2 | 1 | 5 | 1-2min | Быстрое исследование |
| balanced | 6 | 3 | 10 | 3-5min | Сбалансированное |
| quality | 25 | 4 | 20 | 10-15min | Максимальное качество |

### Настройки (Settings)

**Ключевые параметры:**
- `speed_max_iterations`, `speed_max_concurrent`
- `balanced_max_iterations`, `balanced_max_concurrent`
- `quality_max_iterations`, `quality_max_iterations`
- `scraper_use_playwright` - использование Playwright
- `scraper_scroll_enabled` - автоматическая прокрутка
- `rrf_k` - параметр RRF для гибридного поиска

**Код:** `backend/src/config/settings.py`

---

## Расширяемость

### Добавление нового инструмента

1. Добавить действие в `AgentAction` (`schemas.py`)
2. Обновить системный промпт (`researcher.py::get_agentic_system_prompt()`)
3. Реализовать метод `_tool_*` в `AgenticResearcher`
4. Добавить обработку в `_execute_action()`

### Добавление нового режима

1. Создать класс workflow (наследовать от базового)
2. Реализовать `_build_graph()` с узлами LangGraph
3. Добавить в `WorkflowFactory`
4. Обновить роутинг в API

---

## Заключение

Система использует многоуровневую агентную архитектуру с четким разделением ответственности:
- **Supervisor** - стратегическое планирование и координация
- **Researcher** - тактическое выполнение исследований
- **Coordinator** - оркестрация и управление жизненным циклом

Все компоненты работают асинхронно, поддерживают стриминг и используют структурированный вывод для надежности.

